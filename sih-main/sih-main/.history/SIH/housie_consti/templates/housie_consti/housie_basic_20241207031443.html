{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static '/css/housie_board.css' %}">

<div class="min-h-screen flex items-center justify-center bg-gray-100">
    <div class="bg-white p-8 rounded-lg shadow-md max-w-3xl w-full">
        <h2 class="text-3xl font-bold text-center mb-6 historic-title">Constitutional Bingo</h2>
        
        <!-- Current Case Display -->
        <div class="text-center text-lg">
            <p class="font-semibold">Current Case:</p>
            <div class="case-display">
                <div id="timerContainer" class="text-sm mb-2">
                    <span id="timer" class="timer-display">Time remaining: --s</span>
                    <div id="timerBar" class="timer-bar"></div>
                </div>
                <div id="warningMessage" class="hidden warning-message">
                    ‚ö†Ô∏è Last 5 seconds! Make sure you check the right article!
                </div>
                <div id="caseDisplay">
                    <div class="case-text">
                        <h3 class="text-xl font-bold mb-2" id="caseTitle">{{ current_case.title }}</h3>
                        <p class="text-gray-700 mb-4" id="caseDescription">{{ current_case.description }}</p>
                        <p class="text-sm font-semibold">Related Articles: 
                            <span id="relatedArticles">
                                {% for article in current_case.articles %}
                                    Article {{ article.article_number }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player List -->
        <div class="space-y-2">
            <p class="font-semibold">Players in game:</p>
            <ul class="list-disc pl-5">
                {% for player in room.players.all %}
                    <li>{{ player.username }}</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Player Points -->
        <div class="space-y-2 mt-4">
            <p class="font-semibold">Player Points:</p>
            <ul class="list-disc pl-5" id="points-list">
                {% for player in room.players.all %}
                    {% with player_points=player.playerpoints_set.filter.0 %}
                        <li>
                            {{ player.username }}: 
                            <span class="font-bold text-green-600">
                                {% if player_points %}
                                    {{ player_points.points }}
                                {% else %}
                                    0
                                {% endif %}
                                points
                            </span>
                            {% if player == request.user %}
                                <span class="text-blue-600"> (You)</span>
                            {% endif %}
                        </li>
                    {% endwith %}
                {% endfor %}
            </ul>
        </div>

        <!-- Housie Card -->
        <div class="housie-card">
            <h3 class="font-semibold text-center">Your Housie Card</h3>
            <div class="card-grid">
                {% for article in housie_articles %}
                    <div class="card-cell" 
                         data-article-id="{{ article.id }}"
                         data-index="{{ forloop.counter0 }}"
                         onclick="selectArticle(this)">
                        {{ article.title|truncatechars:30 }}
                    </div>
                {% empty %}
                    {% for i in "123456789012345" %}
                        <div class="card-cell">No articles</div>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div data-room-id="{{ room.room_id }}" style="display: none;"></div>

<div id="winnerPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full text-center">
        <h2 class="text-3xl font-bold mb-4 text-green-600">üéâ Winner! üéâ</h2>
        <div id="winnerContent"></div>
        <div class="mt-6">
            <a href="" id="leaderboardLink" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition-colors">
                View Leaderboard
            </a>
        </div>
    </div>
</div>

<script>
    // Add this getCookie function at the top of your script section
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const roomId = document.querySelector('[data-room-id]').getAttribute('data-room-id');
    let currentCase = null;
    let hasSelectedForCurrentCase = false;  // Track if selection made for current case
    let lastCaseId = null;
    let gameStateInterval; // Define interval variable at the top
    let isGameCompleted = false; // Add flag to track game completion

    function updateCaseDisplay(caseData) {
        if (!caseData) return;
        
        // Check if case has changed
        if (lastCaseId !== caseData.id) {
            lastCaseId = caseData.id;
            hasSelectedForCurrentCase = false;
            
            // Reset all card cells except permanently selected ones
            document.querySelectorAll('.card-cell').forEach(cell => {
                if (!cell.classList.contains('permanent-selected')) {
                    cell.classList.remove('selected', 'incorrect');
                    cell.style.pointerEvents = 'auto';  // Re-enable clicking for new case
                }
            });
        }
        
        // Update case display
        const caseTitleElement = document.getElementById('caseTitle');
        const caseDescriptionElement = document.getElementById('caseDescription');
        const relatedArticlesElement = document.getElementById('relatedArticles');
        
        caseTitleElement.textContent = caseData.title || '';
        caseDescriptionElement.textContent = caseData.description || '';
        
        const articleDisplays = caseData.articles ? 
            caseData.articles.map(art => `Article ${art.article_number}`).join(', ') : '';
        relatedArticlesElement.textContent = articleDisplays;
    }

    function updateTimer(timeRemaining) {
        if (isGameCompleted) return;
        
        const timerElement = document.getElementById('timer');
        const timerBar = document.getElementById('timerBar');
        const warningMessage = document.getElementById('warningMessage');
        
        // Check if timeRemaining is a valid number and not undefined
        if (typeof timeRemaining === 'number') {
            const remainingSeconds = Math.max(0, Math.floor(timeRemaining));
            
            // Update timer text
            timerElement.textContent = `Time remaining: ${remainingSeconds}s`;
            
            // Update timer bar
            const percentage = (remainingSeconds / 15) * 100;
            timerBar.style.width = `${percentage}%`;
            
            // Show warning in last 5 seconds
            warningMessage.classList.toggle('hidden', remainingSeconds > 5);
            
            // When timer hits 0, advance to next case
            if (remainingSeconds <= 0 && !isGameCompleted) {
                // Disable selections
                document.querySelectorAll('.card-cell').forEach(cell => {
                    if (!cell.classList.contains('permanent-selected')) {
                        cell.style.pointerEvents = 'none';
                    }
                });
                
                // Force case advancement after a short delay
                setTimeout(() => {
                    fetch(`/housie-consti/advance-case/${roomId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });
                }, 1000);
            }
        } else {
            // Handle invalid timeRemaining value
            console.error('Invalid timeRemaining value:', timeRemaining);
            timerElement.textContent = 'Time remaining: --s';
        }
    }

    function updatePlayerPoints(playerPoints, gameCompletion) {
        const pointsList = document.getElementById('points-list');
        if (!pointsList) return;

        pointsList.innerHTML = '';  // Clear existing list
        
        Object.entries(playerPoints).forEach(([username, points]) => {
            const li = document.createElement('li');
            let completionStatus = '';
            if (gameCompletion && gameCompletion[username]) {
                completionStatus = '<span class="text-purple-600"> (Game Completed!)</span>';
            }
            li.innerHTML = `
                ${username}: 
                <span class="font-bold text-green-600">${points} points</span>
                ${username === '{{ request.user.username }}' ? '<span class="text-blue-600"> (You)</span>' : ''}
                ${completionStatus}
            `;
            pointsList.appendChild(li);
        });
    }

    function showWinnerPopup(winner, finalPoints) {
        // Create popup container
        const popup = document.createElement('div');
        popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        
        // Create popup content
        const content = document.createElement('div');
        content.className = 'bg-white p-8 rounded-lg shadow-xl max-w-md w-full text-center';
        
        // Create confetti effect
        content.innerHTML = `
            <h2 class="text-3xl font-bold mb-4 text-green-600">Game Over!</h2>
            <p class="text-xl mb-6">üéâ Winner: ${winner} üéâ</p>
            <h3 class="text-lg font-semibold mb-2">Final Scores:</h3>
            <div class="space-y-2 mb-6">
                ${Object.entries(finalPoints).map(([player, points]) => `
                    <p class="${player === winner ? 'text-green-600 font-bold' : ''}">
                        ${player}: ${points} points
                    </p>
                `).join('')}
            </div>
            <a href="/housie-consti/leaderboard/${roomId}/" 
               class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition-colors">
                View Leaderboard
            </a>
        `;
        
        popup.appendChild(content);
        document.body.appendChild(popup);
        
        // Add confetti effect
        addConfetti();
    }

    function addConfetti() {
        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 3 + 's';
            document.body.appendChild(confetti);
            
            // Remove confetti after animation
            setTimeout(() => confetti.remove(), 5000);
        }
    }

    function updateGameState(data) {
        if (data.game_completed) {
            isGameCompleted = true; // Set the game completion flag
            const winner = data.winner;
            const finalPoints = data.player_points;
            
            // Show winner popup
            showWinnerPopup(winner, finalPoints);
            
            // Disable further selections
            document.querySelectorAll('.card-cell:not(.permanent-selected)').forEach(cell => {
                cell.style.pointerEvents = 'none';
                cell.style.opacity = '0.5';
            });
            
            // Stop the timer updates
            clearInterval(gameStateInterval);
            
            // Reset timer display
            const timerElement = document.getElementById('timer');
            const timerBar = document.getElementById('timerBar');
            const warningMessage = document.getElementById('warningMessage');
            
            timerElement.textContent = 'Game Completed!';
            timerBar.style.width = '0%';
            warningMessage.classList.add('hidden');
        }
    }

    // Update the fetchGameState function
    function fetchGameState() {
        if (isGameCompleted) return;
        
        fetch(`/housie-consti/get-game-state/${roomId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Game state data:', data); // Debug logging
                
                if (data.current_case) {
                    currentCase = data.current_case;
                    updateCaseDisplay(currentCase);
                }
                
                // Explicitly check if time_remaining is a number
                if (typeof data.time_remaining === 'number') {
                    updateTimer(data.time_remaining);
                } else {
                    console.error('Invalid time_remaining:', data.time_remaining);
                }
                
                if (data.player_points) {
                    updatePlayerPoints(data.player_points, data.game_completion);
                }
                
                // Check for game completion
                if (data.current_case && data.current_case.game_completed) {
                    updateGameState(data.current_case);
                }
                
                // If case just changed, show notification
                if (data.case_changed) {
                    showCaseChangeNotification();
                }
                
                // Check for winner by points
                if (data.player_points) {
                    Object.entries(data.player_points).forEach(([username, points]) => {
                        if (points >= 100 && !isGameCompleted) {
                            isGameCompleted = true;
                            showWinnerPopup(username, points);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching game state:', error);
            });
    }

    function selectArticle(element) {
        if (!currentCase || hasSelectedForCurrentCase) return;
        
        const articleId = element.dataset.articleId;
        
        fetch(`/housie-consti/mark-card-selected/${roomId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                article_id: articleId,
                case_id: currentCase.id
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Correct selection - turn green permanently
                element.classList.add('permanent-selected');
                element.classList.remove('incorrect');
                hasSelectedForCurrentCase = true;
            } else {
                // Incorrect selection - turn red temporarily
                element.classList.add('incorrect');
                console.log('Incorrect selection recorded'); // Debug log
                
                // Reset back to normal after 1 second
                setTimeout(() => {
                    element.classList.remove('incorrect');
                }, 1000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            element.classList.remove('incorrect', 'permanent-selected');
        });
    }

    function showCaseChangeNotification() {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded shadow-lg';
        notification.textContent = 'New Case!';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // Add this function to restore permanent selections on page load
    function restorePermanentSelections() {
        fetch(`/housie-consti/get-selected-cards/${roomId}/`)
            .then(response => response.json())
            .then(data => {
                const selectedCards = data.selected_cards || [];
                document.querySelectorAll('.card-cell').forEach(cell => {
                    const articleId = cell.dataset.articleId;
                    if (selectedCards.includes(parseInt(articleId))) {
                        cell.classList.add('permanent-selected');
                        cell.style.backgroundColor = '#4CAF50';
                        cell.style.color = 'white';
                    }
                });
            })
            .catch(error => console.error('Error:', error));
    }

    // Initialize game state interval when page loads
    document.addEventListener('DOMContentLoaded', () => {
        restorePermanentSelections();
        fetchGameState(); // Fetch immediately
        gameStateInterval = setInterval(fetchGameState, 1000); // Then every second
    });
</script>

<style>
    .timer-bar {
        height: 4px;
        background-color: #4CAF50;
        transition: width 1s linear;
    }

    .warning-message {
        color: #ff0000;
        font-weight: bold;
        margin-top: 4px;
    }

    .card-cell {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        text-align: center;
        font-size: 0.9em;
    }

    .card-cell:hover {
        background-color: #f0f0f0;
    }

    .card-cell.selected {
        background-color: #4CAF50;
        color: white;
    }

    .card-cell.permanent-selected {
        background-color: #4CAF50;
        color: white;
        pointer-events: none;
    }

    .card-cell.incorrect {
        background-color: #ff0000;
        color: white;
        transition: background-color 0.3s;
    }

    .permanent-selected {
        background-color: #4CAF50 !important;
        color: white !important;
        pointer-events: none;
    }

    .incorrect {
        background-color: #FF6B6B !important;
        transition: background-color 0.3s ease;
    }

    .card-cell {
        transition: all 0.3s ease;
    }

    .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        animation: fall 5s linear forwards;
        z-index: 1000;
    }

    @keyframes fall {
        0% {
            transform: translateY(-100vh) rotate(0deg);
        }
        100% {
            transform: translateY(100vh) rotate(360deg);
        }
    }

    .winner-popup {
        animation: popIn 0.5s ease-out forwards;
    }

    @keyframes popIn {
        0% {
            transform: scale(0.5);
            opacity: 0;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    @keyframes confetti {
        0% { transform: translateY(-100vh) rotate(0deg); }
        100% { transform: translateY(100vh) rotate(360deg); }
    }

    .confetti-piece {
        position: fixed;
        width: 10px;
        height: 10px;
        animation: confetti 5s linear infinite;
    }
</style>
{% endblock %}